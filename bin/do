#!/bin/bash
set -euo pipefail

function build-dev-image {
  docker build --target dev --build-arg "DEV_USER_ID=$(id -u)" --build-arg "DEV_GROUP_ID=$(id -g)" "$@" .
}

if [ "${1-}" == "-v" ]; then
  shift
  build-dev-image
fi

image_id=$(build-dev-image --quiet)

mkdir -p "$PWD/build"

exec docker run --rm -it \
  -v "$PWD/src:/deployer/src" \
  -v "$PWD/build:/deployer/build" \
  -v "$PWD/package.json:/deployer/package.json" \
  -v "$PWD/package-lock.json:/deployer/package-lock.json" \
  "$image_id" "$@"
